@using System.Collections
@using Microsoft.AspNet.Identity
@using System.Data;
@using Ppgz.Repository
@{
    ViewBag.Title = "Administracion de Citas";
    ViewBag.Descripcion = "Seleccione la Orden de Compra";
    Layout = "~/Views/Shared/_Layout.cshtml";

    ViewBag.OrdenCompra = (ordencompra)((Hashtable)HttpContext.Current.Session["orden"])["orden"];
    ViewBag.Fecha = ((DateTime)HttpContext.Current.Session["fecha"]).ToString("dd/MM/yyyy");
    var detalles = ((List<ordencompradetalle>) ((Hashtable) HttpContext.Current.Session["orden"])["detalle"]);
    ViewBag.TotalPedido = detalles.AsEnumerable().Sum(x => float.Parse(x.CantidadPedido));
    ViewBag.TotalComprometido = detalles.AsEnumerable().Sum(x => x.CantidadComprometida);

    ViewBag.ordenTmp = "";
}
<style>
    .btn-file {
        position: relative;
        overflow: hidden;
    }

        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }
</style>
<h2>@ViewBag.Title</h2>
<p class="page-description-title">
    <i class="fa fa-calculator" aria-hidden="true"></i> <i>@ViewBag.Descripcion</i>
</p>

<div class="panel panel-default">
    <div class="panel-heading">Datos de la Orden de Compra</div>
    <div class="panel-body">
        <div class="col-md-6">
            <div class="form-group">
                <label>Orden de Compra</label>
                <h4 style="margin-top: 5px">
                   
                    @ViewBag.OrdenCompra.NumeroDocumento
                    

                </h4>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>Fecha</label>
                <h4 style="margin-top: 5px">@ViewBag.Fecha</h4>

            </div>
        </div>

    </div>
    <div class="panel-footer">

        <div class="row">
            <div class="col-md-6">
                <div class="pull-left">
                    <button class="btn btn-info" type="button" onclick=" javascript: history.go(-1); "><i class="fa fa-chevron-left" aria-hidden="true"></i>&nbsp;Regresar</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="pull-right">
                    <button class="btn btn-info" type="button" onclick=""><i class="fa fa-chevron-right" aria-hidden="true"></i>&nbsp;Siguiente</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">Resultado de la Busqueda</div>
    <div class="panel-body">
        <div class="form-group">
            <label class="col-sm-3 control-label">Productos en la Orden</label>
            <div class="col-sm-3">
                <div style="margin-top: 0px; font-size: 1.5em; color: #22aaaa;"><span id="idProductosEnOrden">@ViewBag.TotalPedido</span></div>
            </div>
            <label class="col-sm-3 control-label">Productos en el ASN</label>
            <div class="col-sm-3">
                <div id="total-entregar"style="margin-top: 0px; font-size: 1.5em; color: green;">0</div>
            </div>
        </div>
        <div class="clearfix">
            <form method="POST" action="@Url.Action("CargarDesdePlantilla", "ControlCitas")" enctype="multipart/form-data">
                <label class="btn btn-success btn-file pull-right">
                    <i class="fa fa-arrow-up" aria-hidden="true"></i>
                    Cargar <input type="file" name="cargar-planilla" hidden>

                </label>
            </form>
            <a class="btn btn-primary pull-right" href="@Url.Action("DescargarPlantilla", "ControlCitas")"><i class="fa fa-arrow-down" aria-hidden="true"></i> Descargar Planilla</a>

        </div>
        <p class="form-legend" style="">
            <i>Productos</i>
        </p>
        <table class="table table-striped table-condensed" id="asn">
            <thead>
                <tr>
     
                    <th class="text-center">Material</th>
                    <th class="text-center">Centro</th>
                    <th class="text-center">Almacen</th>
                    <th class="text-center">Descripcion</th>
                    <th class="text-center">Cant. Entregar</th>
                    <th class="text-center">Cant. Pedido</th>

                </tr>
            </thead>
            <tbody>

                @if (ViewBag.origen == "1") {

                    foreach (var orden in ((List<ordencompradetalle>) ((Hashtable) HttpContext.Current.Session["orden"])["detalle"]))
                    {

                        ViewBag.ordenTmp = orden.NumeroDocumento;
                        
                    
                        
                    <tr>

                            <td class="text-center"> @orden.NumeroMaterial</td>
                            <td class="text-center"> @orden.Centro</td>
                            <td class="text-center"> @orden.Almacen</td>
                            <td class="text-center"> @orden.DescripcionMaterial</td>
                            <td class="text-center" style="font-weight: bold; cursor: pointer"> @orden.CantidadComprometida</td>
                            <td class="text-center"style="font-weight: bold; cursor: pointer"> @orden.CantidadPedido</td>

                        </tr>

                    }
                }
                else if (ViewBag.origen == "2")
                {
                    List<ordencompradetalle> resultado = new List<ordencompradetalle>((List<ordencompradetalle>)ViewBag.Detalles);
                   foreach (var orden in resultado)
                   {
                       ViewBag.ordenTmp = orden.NumeroDocumento;
                       
                        <tr>

                            <td class="text-center"> @orden.NumeroMaterial</td>
                            <td class="text-center"> @orden.Centro</td>
                            <td class="text-center"> @orden.Almacen</td>
                            <td class="text-center"> @orden.DescripcionMaterial</td>
                            <td class="text-center" style="font-weight: bold; cursor: pointer"> @orden.CantidadComprometida</td>
                            <td class="text-center"style="font-weight: bold; cursor: pointer"> @orden.CantidadPedido </td>

                        </tr>

                    }
                    
                };

            </tbody>
        </table>

    </div>
</div>
<div class="modal fade" id="modalEditarCantidad" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Modificar Cantidad <span class="codigo"></span></h4>
            </div>
            <div class="modal-body">
                <div>
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-xs-4 control-label">Material</label>
                            <div class="col-xs-8">
                                <label class="control-label" id="editar-material"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-4 control-label">Descripcion</label>
                            <div class="col-xs-8">
                                <label class="control-label" id="editar-descripcion"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-4 control-label">Cantidad</label>
                            <div class="col-xs-8">
                                <input type="text" class="form-control" id="editar-cantidad" placeholder="Cantidad">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-4 col-sm-8">
                                <button type="submit" onclick="agregarModificado()" class="btn btn-primary" data-dismiss="modal">Actualizar</button>
                                <button type="submit" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>




@Scripts.Render("~/Scripts/jquery-1.10.2.js");

@section Scripts {

    <script type="text/javascript">

        $("input[name='cargar-planilla']").change(function() { this.form.submit(); });

        var editingCell;
        var editingTd;

        $(document).ready(function() {

            var valOrdenesCargadas = '@Request.RequestContext.HttpContext.Session["ordenesCargadas"]';

            for (i = 0; i <= valOrdenesCargadas; i++) {

                var nombre = "ordenTemp" + i;
                console.log("Valor de Session: ordenTemp [" + i + "]: ");

            }



            var asn = $('#asn').DataTable({
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/1.10.13/i18n/Spanish.json"
                },
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Todos"]]
            });


            $('#asn tbody').on('click', 'td:nth-child(5)', function() {
                $("#editar-material").text($($(this.parentNode).find('td')[0]).text());
                $("#editar-descripcion").text($($(this.parentNode).find('td')[3]).text());
                $("#editar-cantidad").val($($(this.parentNode).find('td')[4]).text());
                $("#modalEditarCantidad").modal('show');
                editingCell = asn.cell(this);
                editingTd = this;
            });


            $('#modalEditarCantidad').on('hidden.bs.modal', function(e) {

                var cantidadOrg = parseFloat($($(editingTd).parent().find('td')[5]).text());

                var cantidadNueva = parseFloat($("#editar-cantidad").val());
                var vlItem = $($(this.parentNode).find('td')[0]).text();
                var vlNumOrden = "@ViewBag.ordenTmp";

                if (isNaN(cantidadNueva)) {
                    //todo mejorar
                    //alert("cantidad incorrecta");
                    msgError("cantidad incorrecta");
                    return;
                }
                if (cantidadNueva > cantidadOrg) {
                    //todo mejorar
                    //alert("cantidad incorrecta");
                    msgError("cantidad incorrecta");

                    return;
                }

                if (cantidadNueva < cantidadOrg) {
                    editingCell.data(cantidadNueva.toFixed(3)).draw();
                    $(editingTd).css("color", "red");
                    // $($(editingTd.parentNode).find('td')[5]).html('<i class="fa fa-1x fa-exclamation-triangle" aria-hidden="true"></i>  Solicitado: ' + cantidadOrg);
                    // $($(editingTd.parentNode).find('td')[5]).css("color", "#fe7000");
                    calcularTotalEntregar();

                    var requestData = {
                        Orden: vlNumOrden.trim(),
                        Item: vlItem.trim(),
                        OldValue: cantidadOrg ,
                        NewValue: cantidadNueva
                    };

                    $.ajax({
                        url: '/ControlCitas/updItemOrden',
                        type: 'POST',
                        data: JSON.stringify(requestData),
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        error: function (xhr) {
                            alert('Error: ' + xhr.statusText);
                        },
                        success: function (result) {
                            alert(result);
                        },
                        async: true,
                        processData: false
                    });

                }

            });

            calcularTotalEntregar();


        });

        function calcularTotalEntregar() {
            var totalEntregar = 0;
            $($(asn).DataTable().column(4).data()).each(function() {
                totalEntregar = totalEntregar + parseFloat(this);
            });
            $("#total-entregar").text(totalEntregar);

        }

    </script>
}
