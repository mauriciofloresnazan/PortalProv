@using System.Data.Entity.Core.Mapping
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div>
    <h2>Editar Cuenta de Proveedor <a class="btn btn-default" href="@Url.Action("Index", "AdministrarProveedores")"><i class="fa fa-undo" aria-hidden="true"></i> Cancelar</a></h2>
    <p class="page-description-title"><i class="fa fa-info" aria-hidden="true"></i> <i>Información de la cuenta</i>
        
    </p>

    <div class="col-sm-6">

        <div class="row">
            <div class="col-sm-4"><strong>Codigo</strong>
            </div>
            <div class=" col-sm-8" style=""><span style="color: #66aaaa;">@ViewBag.cuenta.CodigoProveedor</span></div>
        </div>
        <div class="row">
            <div class="col-sm-4"><strong>Nombre</strong>
            </div>
            <div class="col-sm-8">@ViewBag.cuenta.NombreProveedor</div>
        </div>
        <hr/>
        <div class="row">
            <div class="col-sm-4"><strong>Resp.</strong>
            </div>
            <div class="col-sm-8">
                <p>
                    @(ViewBag.cuenta.AspNetUser1.Nombre + ' ' + ViewBag.cuenta.AspNetUser1.Apellido)<i>
                        
                    </i><br>
                    @ViewBag.cuenta.AspNetUser1.Email
                </p>
            </div>
        </div>


    </div>
    <div class="col-sm-6" style="display: none">
        <div class="row">
            <div class="col-sm-3"><strong>Estatus</strong>
            </div>
            <div class=" col-sm-9">
                <p>
                    @if (ViewBag.cuenta.AspNetUser1.Activo)
                    {
                        <span>ACTIVO</span>
                    }
                    else
                    {
                        <span>SUSPENDIDO</span>
                    }
                </p>
            </div>
        </div>
       <hr/>
        <div>
            <div class="col-md-6">
                <select class="form-control" id="usuariosMaestrosSelect">
                    <option value="">Cambiar U. Maestro</option>
                    @foreach (var usuario in ViewBag.cuenta.AspNetUsers)
                    {
                        <option value="@usuario.Id">@(usuario.Nombre + ' ' + usuario.Apellido)</option>

                    }

                </select>
            </div>
            <div class="col-md-6"><a id="cambiarMaestro" class="btn btn-danger center-block">
    <i class="fa fa-pencil" aria-hidden="true"></i>
    Modificar
</a>
            </div>

        </div>
        <p>
            

            
        </p>
    </div>
</div>
<div class="clearfix"></div>

<div class="panel panel-default">
    <div class="panel-heading">Numeros de Proveedor SAP asociados a la cuenta</div>
    <div class="panel-body">

        <table class="table table-striped table-condensed table-bordered" style="font-size: .8em;">
            <thead>
                <tr>
                    <th colspan="12">
                        <div class="col-sm-12"><label>Asociar proveedor desde SAP</label></div>
                        <div class="col-sm-3">

                            <input type="text" name="numero-proveedor" id="numero-proveedor" placeholder="Número de Proveedor" class="form-control"/>
                        </div>
                        <div class="col-sm-7">
                            <a id="buscar" class="btn btn-primary" href="#"><i class="fa fa-search" aria-hidden="true"></i> Buscar</a>
                        </div>
                    </th>
                </tr>
                <tr>
                    <th class="text-center vert-align">Numero</th>
                    <th class="text-center vert-align">RFC</th>
                    <th class="text-center vert-align">Nombre</th>
                    <th class="text-center vert-align">Ciudad</th>
                    <th class="text-center vert-align">Estado</th>
                    <th class="text-center vert-align">Codigo Postal</th>
                    <th class="text-center vert-align">Dirección 1</th>
                    <th class="text-center vert-align">Dirección 2</th>
                    <th class="text-center vert-align">Dirección 3</th>
                    <th class="text-center vert-align">Email</th>
                    <th>
                    </th>

                </tr>
            </thead>
            <tbody>
            @foreach (var proveedor in ViewBag.cuenta.proveedores)
            {
                <tr>
                    <td>@proveedor.CodigoProveedor</td>
                    <td>@proveedor.Rfc</td>
                    <td>@proveedor.NombreProveedor</td>
                    <td>@proveedor.Ciudad</td>
                    <td>@proveedor.Estado</td>
                    <td>@proveedor.CodigoPostal</td>
                    <td>@proveedor.direccion1</td> 
                    <td>@proveedor.direccion2</td>
                    <td>@proveedor.direccion3</td>
                    <td>@proveedor.email</td>
                    <td>
                        
                        <div class="">
                            
                            <a class="btn btn-danger btn-xs" href="@Url.Action("DesAsociarProveedor", "AdministrarProveedores", new { @id = @proveedor.Id })" data-toggle="confirmation" data-btn-ok-label="Si" data-title="¿Esta seguro?" data-content="Cuidad el proveedor será desvinculado de la cuenta.">
                                <i class="fa fa-times" aria-hidden="true"></i> Eliminar
                            </a>
                        </div>
                    </td>
                </tr>
                
            }


            </tbody>
        </table>



    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="buscarModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header"><strong>Datos del Proveedor</strong>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"><span id="mensaje-titulo"></span></h4>
            </div>
            <div class="modal-body">


            </div>
            <div class="modal-footer">
                <a id="asociar-proveedor" class="btn btn-primary btn-lg">Asociar</a>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="buscarModalError" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <strong>Error de busquueda del Proveedor</strong>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"><span id="mensaje-titulo"></span></h4>
            </div>
            <div class="modal-body">
                <p id="buscarModalError-content"></p>

            </div>
        </div>
    </div>
</div>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        var urlModUsuarioMaestro = "@Url.Action("ModificarUsuarioMaestro", "AdministrarProveedores")";
        var cuentaId = "@ViewBag.cuenta.Id";

        function modificarUsuarioMaestro(id, usuarioId ) {
            var link = urlModUsuarioMaestro + "/" +id + "?usuarioId=" + usuarioId;

            location.href = link;

        }


        $("#cambiarMaestro").click(function () {
            var usuariosMaestrosSelect = $("#usuariosMaestrosSelect");

            if (usuariosMaestrosSelect.val() !== "") {
                modificarUsuarioMaestro(cuentaId, usuariosMaestrosSelect.val());
            }
        });

        $("#buscar").click(function () {

            if ($("#numero-proveedor").val() !== "") {
                buscarNumeroProveedor($("#numero-proveedor").val());
           }

        });
        
        var urlBuscarProveedor = "@Url.Action("BuscarProveedor", "AdministrarProveedores")";

        var urlAsociarProveedor =  "@Url.Action("AsociarProveedor", "AdministrarProveedores")";

        function buscarNumeroProveedor(numeroProveedor) {


 
            var data = {
                numeroProveedor: numeroProveedor
            };

            $.ajax({
                type: "POST",
                url: urlBuscarProveedor,
                data: data,
                cache: false
            }).done(function (result) {

                if (result.error) {
                   
                    $("#buscarModalError-content").text(result.error);
                    $('#buscarModalError').modal('show');
                    return;
                }
                $("#buscarModal .modal-body").html("");


                for (var key in result) {

                    $("#buscarModal .modal-body").append("<label>" + key + "</label>");
                    $("#buscarModal .modal-body").append("<p>" + result[key] + "</p>");
                }


                $("#asociar-proveedor").attr("href", urlAsociarProveedor + "/" + cuentaId + "?numeroProveedor=" + numeroProveedor);
                

                $('#buscarModal').modal('show');


            }).fail(function (response) {
                $('#buscarModal').modal('show');
     
            });
        }



    </script>
}