@using Ppgz.Repository
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
    var cuenta = (cuenta)@ViewBag.cuentaConUsuarioMaestro.Cuenta;
    var usuarioMaestro = (AspNetUser)@ViewBag.cuentaConUsuarioMaestro.UsuarioMaestro;
}

<div>
    <h2>Editar Cuenta de Proveedor <a class="btn btn-default" href="@Url.Action("Index", "AdministrarProveedores")"><i class="fa fa-undo" aria-hidden="true"></i> Cancelar</a></h2>
    <p class="page-description-title">
        <i class="fa fa-info" aria-hidden="true"></i> <i>Información de la cuenta</i>
    </p>

    <div class="col-sm-6">
        <div class="row">
            <div class="col-sm-4">
                <strong>Id</strong>
            </div>
            <div class=" col-sm-8" style=""><span style="color: #66aaaa;">@cuenta.Id</span></div>
        </div>
        <div class="row">
            <div class="col-sm-4">
                <strong>Nombre</strong>
            </div>
            <div class="col-sm-8">@cuenta.NombreCuenta</div>
        </div>
        <hr />
        <div class="row">
            <div class="col-sm-4">
                <strong>Responsable</strong>
            </div>
            <div class="col-sm-8">
                <p>
                    @(usuarioMaestro.Nombre + ' ' + usuarioMaestro.Apellido)<i>
                    </i><br>
                    @usuarioMaestro.Email
                </p>
            </div>
        </div>
    </div>
</div>
<div class="clearfix"></div>
<div class="panel panel-default">
    <div class="panel-heading">Proveedores SAP asociados a la cuenta</div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="table table-striped table-condensed table-bordered" style="font-size: .8em;">
                <thead>
                <tr>
                    <th colspan="13">
                        <div class="col-sm-12">
                            <label>Asociar proveedor desde SAP</label>
                        </div>
                        <form id="buscar-form" method="POST">
                            <div class="col-sm-3">
                                <input type="text" name="numero-proveedor" id="numero-proveedor" placeholder="Número de Proveedor" class="form-control"/>
                            </div>
                            <div class="col-sm-7">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-search" aria-hidden="true"></i> Buscar
                                </button>
                            </div>
                        </form>
                    </th>
                </tr>
                <tr>
                    <th class="text-center vert-align">Numero</th>
                    <th class="text-center vert-align">RFC</th>
                    <th class="text-center vert-align">Nombre</th>
                    <th class="text-center vert-align">Teléfono</th>
                    <th class="text-center vert-align">Email</th>
                    <th class="text-center vert-align">Vendedor</th>
                    <th class="text-center vert-align">Región</th>
                    <th class="text-center vert-align">Población</th>
                    <th class="text-center vert-align">Apartado</th>
                    <th class="text-center vert-align">Distrito</th>
                    <th class="text-center vert-align">Codigo Postal</th>
                    <th class="text-center vert-align">Dirección</th>
                    <th>
                    </th>

                </tr>
                </thead>
                <tbody>
                @foreach (proveedore proveedor in ViewBag.cuentaConUsuarioMaestro.Cuenta.proveedores)
                {
                    <tr>
                        <td class="vert-align">@proveedor.NumeroProveedor</td>
                        <td class="vert-align">@proveedor.Rfc</td>
                        <td class="vert-align">@proveedor.Nombre1 @proveedor.Nombre2 @proveedor.Nombre3 @proveedor.Nombre4</td>
                        <td class="vert-align">@proveedor.NumeroTelefono</td>
                        <td class="vert-align">@proveedor.Correo</td>
                        <td class="vert-align">@proveedor.VendedorResponsable</td>
                        <td class="vert-align">@proveedor.Region</td>
                        <td class="vert-align">@proveedor.Poblacion</td>
                        <td class="vert-align">@proveedor.Apartado</td>
                        <td class="vert-align">@proveedor.Distrito</td>
                        <td class="vert-align">@proveedor.CodigoPostal</td>
                        <td class ="vert-align">@proveedor.Direccion</td>
                        <td>
                            <div class="btn-group-vertical">
                                <a class="btn btn-danger btn-xs" href="@Url.Action("DesAsociarProveedor", "AdministrarProveedores", new {cuentaId = @ViewBag.cuentaConUsuarioMaestro.Cuenta.Id, proveedorId = @proveedor.Id})" data-toggle="confirmation" data-btn-ok-label="Si" data-title="¿Esta seguro?" data-content="Cuidad el proveedor será desvinculado de la cuenta.">
                                    <i class="fa fa-times" aria-hidden="true"></i> Eliminar
                                </a>
                                <a class="btn btn-warning btn-xs" href="@Url.Action("RefrescarProveedor", "AdministrarProveedores", new { cuentaId = @ViewBag.cuentaConUsuarioMaestro.Cuenta.Id, proveedorId = @proveedor.Id })">
                                    <i class="fa fa-refresh" aria-hidden="true"></i> Actualizar
                                </a>
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade bd-example-modal-lg" id="buscarModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"></h4>

            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="buscarModalError" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <strong>Error de busqueda del Proveedor</strong>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"><span id="mensaje-titulo"></span></h4>
            </div>
            <div class="modal-body">
                <p id="buscarModalError-content"></p>

            </div>
        </div>
    </div>
</div>
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">

        var cuentaId = "@ViewBag.cuentaConUsuarioMaestro.Cuenta.Id";

        $(function () {
            $("#buscar-form").submit(function (e) {
                buscarProveedor();
                e.preventDefault();
            });
        });

        var urlBuscarProveedor = "@Url.Action("BuscarProveedor", "AdministrarProveedores")";

        var urlAsociarProveedor = "@Url.Action("AsociarProveedor", "AdministrarProveedores")";

        function buscarProveedor() {

            var data = {
                numeroProveedor: $("#numero-proveedor").val()
            };

            $.ajax({
                type: "POST",
                url: urlBuscarProveedor,
                data: data,
                cache: false
            }).done(function (result) {

                if (result.error) {

                    $("#buscarModalError-content").text(result.error);
                    $('#buscarModalError').modal('show');
                    return;
                }

                var title = $("#buscarModal .modal-title");
                var body = $("#buscarModal .modal-body");
                var footer = $("#buscarModal .modal-footer");

                $(body).html("");
                $(footer).html("");
                $(title).text("Datos del Proveedor #" + data.numeroProveedor);
                var dl = $("<dl class='dl-horizontal'></dl>").appendTo(body);
              
                for (var key in result) {
                    if (result.hasOwnProperty(key)) {
                        $(dl).append("<dt>" + key + "</dt>");
                        $(dl).append("<dd>" + result[key] + "</dd>");
                    }
                }
                var asociarLink = $("<a class='btn btn-primary btn-lg'><i class='fa fa-link' aria-hidden='true'></i> Asociar</a>").appendTo(footer);

                $(asociarLink).attr("href", urlAsociarProveedor + "/" + cuentaId + "?numeroProveedor=" + data.numeroProveedor);

                $('#buscarModal').modal('show');


            }).fail(function (response) {
                $('#buscarModal').modal('show');

            });
        }


    </script>
}